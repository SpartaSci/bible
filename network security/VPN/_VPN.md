---
aliases:
  - VPN
---
> The VPN is a connectivity realized on a **shared infrastructure** (private/public network and Internet) such that policies (security, QoS, reliability, addressing, etc.) can be enforced as in a **private network**.

# general concept

In VPN are important two things:
- a **tunnel** which is a secure encapsulation of corporate traffic while in transit on the shared network
- a **VPN Gateway** which is a termination device on the corporate network and it can be a tunnel endpoint

Intra vs extra
- **Intranet VPN**: interconnection of corporate headquarters, remote offices, traveling employees or smart workers. In intranet VPNs, each company has got its own security policy completely independent from policies of other companies.
- **Extranet VPN**: interconnection of customers, suppliers, partners or communities of interest to a corporate intranet. It provides controlled access to an individual customer/partner/provider user.  In the extranet VPN, the access to network resources form interconnected networks should be restricted through a firewall and it is possible to overlap the address spaces, so a Network Address Translation (NAT) is needed.

Moreover the internet access when a VPN is implemented can be centralized or distributed.
- In the **centralized connection**, the remote branches/users use public IP network only to reach headquarters and then, they can access internet but only from headquarters. In this way the company can perform a centralized access control, maybe using a firewall. 
- The **distributed connection** is different because remote branches/users access the Internet through IP network connection.


Using a VPN allows to have separate data (via **tunneling**), to increase protection (via **encryption**), to prevent tampering (**integrity** must be guaranteed) and to identify the source (via **authentication**). 

Moreover, the tunnel must be implemented and there are many solutions:
- **Site-to-Site VPN tunneling**: the operations for tunneling are performed by the gateways (for both source and destination) and not by the host itself. The tunnel is created between the gateways and not on the internal network but only on the external one.
- **End-to-End VPN tunneling**: the operations for tunneling are directly performed by the end systems. The tunnel is created between the two end systems; so, the traffic is secure also in the internal network.
- **Remote Access VPN tunneling**: the tunnel is created between the VPN gateway of the corporate network and the end system which needs to perform the remote access, maybe to a company.

There are two VPN models:
- **Overlay Model**: In this model, the VPN operates independently of the public network services. Routing is performed by the VPN gateways, so each VPN gateway must be ”in touch” with every other VPN gateway. In this way, the routing is not optimized, but the traffic is secure because the traffic is decapsulated/encapsulated only by the source gateway or the destination gateway.
- **Peer Model**: In this model, each VPN gateway interacts with a public router (its peer) in order to optimize the routing. Thus, the traffic is encapsulated/decapsulated by all the routers along the path, which can lead to a loss of security because if a router is compromised, the traffic can be analyzed; the router becomes the point of failure. Moreover, if a router checks its routing table at each step, end-to-end VPN cannot be created.

VPNs can be implemented by:
- **Customer Provisioned VPN**: customer implements VPN solution and the network provider is not aware that the traffic generated by customer is VPN. In this approach, the customer must have the capacity to create and manage the VPN (more difficult). But if the VPN is done in this way, the traffic is secure during the path because the traffic that will pass through provider devices will be encapsulated or decapsulated only on the customer network. At the end, the tunneling is performed by customer equipment. ^bfee45
- **Provider Provisioned VPN**: provider implements VPN solution and the traffic belonging to different VPNs is separated by the provider devices. In this way, the customer doesn’t care about how the VPN is created and managed but the traffic is a bit less secure because decapsulation or encapsulation is done on the last device of the provider to enter or exit the customer network. At the end, the tunneling is performed by provider equipment.

The topology of a (virtual) VPN can be different:
- **Hub and Spoke Topology**: Each branch communicates directly with headquarters, and the number of tunnels required is smaller than in a Mesh topology. Nevertheless, the routing is sub-optimal, and the hub could become a bottleneck.
- **Mesh Topology**: In this topology, a larger number of tunnels are required and are harder to manually configure, but it is optimized for routing.



# tunneling

VPNs can be implemented at different layers:

**Layer 2**:
-  **Virtual Private LAN Service**:
	- Emulates functionalities of LANs.
	- Can be used to connect LAN segments.
	- Works as a single LAN through the public network.
	- VPN solution emulates learning bridges.
	- Routing based on MAC addresses.
- **Virtual Private Wire Service**:
	- Emulates a leased line.
	- Any protocol can be carried.
- **IP-Only LAN-like Service**:
	- CEs are IP routers or IP hosts (not Ethernet switches).
	- Only IP (plus ICMP and ARP) packets travel through the VPN.

 **Layer 3**:
- Packets are forwarded through the public network, and routing is based on Layer 3 addresses given that the routers and the hosts have IP addresses.
- Tunneling in a Layer 3 VPN means that a packet is carried through an *IP network within an IP packet (IP-in-IP tunnelling)*, so an extra header for the tunneling is added. Typically, the protocols for performing the tunneling operation are [[network security/VPN/GRE - Generic Routing Encapsulation|GRE]] or [[network security/VPN/L3 - IPsec/_IPsec|_IPsec]].


**Layer 4**:
- The VPN is built using TCP connections, and an extra header at Layer 4 is needed in addition to an extra header at Layer 3 to manage the networking.
- Without the Layer 3 header, it is impossible to establish a *Site-to-Site connection*.
- The security in these types of VPNs is achieved using SSL/TLS.
- In a Layer 4 *End-to-End VPN*, the tunneling is done in an easier way because only one extra header is needed since the tunneling is performed directly by the hosts.

# Layer 2 frame, within an IP packet
At Layer 2 there are two protocols for **Access VPN**:
- [[network security/VPN/L2 - Layer2/L2TP (Layer 2 Tunneling Protocol)|L2TP]] (Layer 2 Tunneling Protocol): it uses IPsec to reach security (complicated) and it is independent of layer 2 protocol on host. It is considered as Provider provisioner.
- [[network security/VPN/L2 - Layer2/PPTP (Point-to-Point Tunneling Protocol)|PPTP]] (Point-to-Point Tunneling Protocol): it is Customer provisioner and it has got its own weak mechanism for encryption and authentication. It was initially deployed and then adopted and modified by Microsoft.



# Layer 3 IPsec VPN
layer 3
[[network security/VPN/L3 - IPsec/_IPsec|_IPsec]]

# Layer 4 SSL VPN
layer 4
[[network security/VPN/L4 - SSL/SSL|SSL]]





# VPN gateway positioning

Now, where should we position a VPN Gateway?

**Inside**: it implies no inspection of VPN traffic (by the firewall because the firewall can also pass through the traffic to the gateway) and that the VPN gateway is protected by the firewall because it is inside the network.

**Outside**: it implies that the VPN gateway is protected by access router (weak) but the content of traffic can be analyzed by the firewall because it is decrypted before arriving to the firewall that is the next hop after the VPN gateway when it is put outside the internal network.

**Integrated**: it allows to reach maximum flexibility.

**Parallel**: it can lead to potential uncontrolled access.

An other problem of the VPN gateways is the use of NAT because the NAT can change the addresses (the checksum will fail and so on) and so on. For this and other reasons, the NAT should be put before the gateway.


Ideologically correct order should be: NAT → Firewall → VPN Gateway → Firewall. In this way, the traffic can be analyzed in any case and the gateway is protected as well. Typically, also the [[network security/Monitoring/IDS - Intrusion Detection System|IDS]] is usually outside the firewall.


Moreover, there can be different anomalies that can occur. We analyzed two anomalies, both belonging to anomalies related to insecure communications.

**Monitorability anomaly**: it is when some nodes at the channel junctions can see the exchanged data.

**Skewed channel**: it is when a wrong tunnel overlapping removes the confidentiality in a part of the communication.